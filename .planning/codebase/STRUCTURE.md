# Codebase Structure

**Analysis Date:** 2026-01-19

## Directory Layout

```
_dotfiles/
├── bootstrap.sh              # Interactive setup script for new machines
├── setup.yml                 # Main Ansible playbook (imports all tools)
├── setup-all.sh              # Run setup on all hosts
├── ansible.cfg               # Ansible configuration (inventory, SOPS plugin)
├── inventory.yml             # Remote hosts inventory
├── localhost.yml             # Local machine inventory (generated by bootstrap)
├── requirements.yml          # Ansible Galaxy requirements
├── CLAUDE.md                 # AI assistant instructions
├── README.md                 # Project documentation
├── .sops.yaml                # SOPS encryption rules
├── .gitignore                # Git ignore patterns
├── group_vars/
│   └── all/
│       └── personal-info.sops.yml  # Encrypted secrets
├── tools/                    # 101 tool directories
│   └── <tool>/
│       ├── install_<tool>.yml      # Ansible playbook
│       ├── <tool>.zsh              # Shell config (optional)
│       ├── *.j2                    # Jinja2 templates (optional)
│       └── <configs>               # App configs (optional)
├── themes/                   # Visual customization playbooks
│   ├── _color.yml            # Color scheme switcher
│   ├── _font.yml             # Font switcher
│   └── _style.yml            # Powerline separator style switcher
├── infrastructure/           # Pulumi IaC for DigitalOcean
│   ├── index.ts              # Droplet definition
│   ├── package.json          # Node dependencies
│   └── Pulumi.*.yaml         # Stack configs
├── .claude/                  # Claude Code configuration
│   ├── settings.local.json   # Local settings
│   ├── commands/             # Slash commands
│   ├── hooks/                # Event hooks
│   └── rules/                # Context rules
└── .planning/                # GSD planning documents
    └── codebase/             # Codebase analysis docs
```

## Directory Purposes

**tools/:**
- Purpose: Per-tool installation and configuration
- Contains: 101 directories, each with install_<tool>.yml playbook
- Key files: Shell configs (*.zsh), templates (*.j2), app configs

**group_vars/:**
- Purpose: Ansible variables shared across all hosts
- Contains: SOPS-encrypted secrets
- Key files: `all/personal-info.sops.yml`

**themes/:**
- Purpose: Runtime theme switching without re-running full playbook
- Contains: Color, font, and powerline style playbooks
- Key files: `_color.yml`, `_font.yml`, `_style.yml`

**infrastructure/:**
- Purpose: Cloud infrastructure provisioning
- Contains: Pulumi TypeScript project for DigitalOcean
- Key files: `index.ts`, `Pulumi.dev.yaml`

**.claude/:**
- Purpose: Claude Code AI assistant configuration
- Contains: Commands, hooks, rules for repo-specific behavior
- Key files: `settings.local.json`

## Key File Locations

**Entry Points:**
- `bootstrap.sh`: New machine setup
- `setup.yml`: Main playbook for full environment
- `setup-all.sh`: Multi-host execution wrapper

**Configuration:**
- `ansible.cfg`: Ansible behavior (inventory path, SOPS plugin)
- `.sops.yaml`: Encryption rules (Age recipient)
- `inventory.yml`: Remote host definitions
- `localhost.yml`: Local host definition (generated)

**Secrets:**
- `group_vars/all/personal-info.sops.yml`: Encrypted user data

**Core Shell:**
- `tools/zsh/zshrc`: Base zsh configuration
- `tools/zsh/install_zsh.yml`: Zsh and plugins installation

**Testing:**
- No formal test suite; use `ansible-playbook --check --diff` for dry-run validation

## Naming Conventions

**Files:**
- Playbooks: `install_<tool>.yml` (always lowercase, matches directory)
- Shell configs: `<tool>.zsh` (sourced into ~/.zshrc)
- Templates: `<name>.j2` (Jinja2 extension)
- Configs: Match target app's expected filename

**Directories:**
- Tools: lowercase, hyphens for multi-word (`claude-code`, `build-essential`)
- Underscore prefix for shared includes (`_color.yml`)

**Variables:**
- Snake_case for Ansible variables (`git_signing_key`, `ssh_public_key`)
- SOPS-encrypted variables have same names as plaintext

**Templates:**
- Platform variants: `<name>.<platform>.j2` (e.g., `gitconfig.darwin.j2`)
- Shared includes: `<name>.base.j2`, `<name>.personal.j2`

## Where to Add New Code

**New Tool:**
1. Create directory: `tools/<newtool>/`
2. Create playbook: `tools/<newtool>/install_<newtool>.yml`
3. Add import to `setup.yml` in appropriate position (respect dependencies)
4. Optional: Add `<newtool>.zsh` for shell integration
5. Optional: Add config files to copy/template

**New Tool Playbook Pattern:**
```yaml
- name: Install <newtool>
  hosts: all  # or specific group like with_gui_tools
  gather_facts: true
  tasks:
    - name: Install via Homebrew (macOS)
      shell: /opt/homebrew/bin/brew install <newtool>
      args:
        creates: /opt/homebrew/bin/<newtool>
      when: ansible_facts['os_family'] == "Darwin"

    - name: Install via apt (Debian)
      apt:
        name: <newtool>
        state: present
      become: yes
      when: ansible_facts['os_family'] == "Debian"

    - name: Install via pacman (Arch)
      pacman:
        name: <newtool>
        state: present
      become: yes
      when: ansible_facts['os_family'] == "Archlinux"
```

**New Secret:**
1. Add variable to `group_vars/all/personal-info.sops.yml`
2. Encrypt: `sops group_vars/all/personal-info.sops.yml`
3. Reference in playbooks: `{{ variable_name }}`

**New Host Group:**
1. Add group to `inventory.yml` under `all.children`
2. List member hosts
3. Reference in playbooks: `hosts: <group_name>` or `'<group>' in group_names`

**New Theme Style:**
1. Add entry to `styles` dict in `themes/_style.yml`
2. Format: `name: { right: "\uXXXX", left: "\uYYYY", right_code: "0xXXXX", left_code: "0xYYYY" }`

## Special Directories

**tools/neovim/nvim/:**
- Purpose: Complete Neovim configuration
- Generated: No (manually maintained)
- Committed: Yes
- Contains: `init.lua`, `lua/` modules

**~/.local/share/nvim/mason/:**
- Purpose: Mason-managed LSP servers and tools
- Generated: Yes (via Mason install task)
- Committed: No (target machine only)

**~/.config/zsh/:**
- Purpose: Tool-specific shell configs deployed from tools/
- Generated: Yes (via Ansible)
- Committed: No (target machine only)

**~/.config/op/:**
- Purpose: 1Password service account token
- Generated: Yes (via bootstrap)
- Committed: No (secrets, machine-specific)

**~/.config/sops/age/:**
- Purpose: Age encryption keys
- Generated: Yes (via bootstrap or manual)
- Committed: No (secrets, machine-specific)

## File Counts by Type

| Pattern | Count |
|---------|-------|
| install_*.yml | 101 |
| *.zsh | 13 |
| *.j2 | 7 |
| Tools directories | 101 |

---

*Structure analysis: 2026-01-19*
