---
phase: 02-structure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - CLAUDE.md
  - .claude/README.md
  - .claude/rules/.gitkeep
  - .claude/commands/.gitkeep
  - .claude/hooks/.gitkeep
  - tools/claude-code/install_claude-code.yml
autonomous: true

must_haves:
  truths:
    - "Developer reading CLAUDE.md understands the three-layer architecture"
    - "Developer knows what belongs at user vs portable vs repo level"
    - "New machine gets ~/.claude/ scaffold via Ansible"
    - "Repo has clean .claude/ scaffold ready for future configs"
  artifacts:
    - path: "CLAUDE.md"
      provides: "Three-layer architecture documentation"
      contains: "## Claude Code Configuration"
    - path: ".claude/README.md"
      provides: "Repo-level scaffold documentation"
      min_lines: 10
    - path: "tools/claude-code/install_claude-code.yml"
      provides: "User-level scaffold via Ansible"
      contains: "commands"
  key_links:
    - from: "CLAUDE.md"
      to: "~/.claude/"
      via: "documents user layer"
      pattern: "User Layer"
    - from: "CLAUDE.md"
      to: ".claude/"
      via: "documents repo layer"
      pattern: "Repo Layer"
    - from: "tools/claude-code/install_claude-code.yml"
      to: "~/.claude/"
      via: "creates scaffold directories"
      pattern: "file:.*path:.*\\.claude"
---

<objective>
Document the three-layer Claude Code configuration architecture and create clean scaffolds at both user and repo levels.

Purpose: Establish clear ownership rules so future Claude Code configuration work has obvious locations. Make it impossible to confuse where config belongs.

Output: Updated CLAUDE.md with architecture docs, clean repo-level `.claude/` scaffold with README, updated Ansible playbook that creates user-level scaffold on deployment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@CLAUDE.md
@tools/claude-code/install_claude-code.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document three-layer architecture in CLAUDE.md</name>
  <files>CLAUDE.md</files>
  <action>
Add a new section "## Claude Code Configuration" BEFORE the "## Nerd Font / Powerline Characters" section. The section should document:

1. **Three-Layer Architecture Overview**
   - User Layer (`~/.claude/`): Global defaults deployed by Ansible, applies to all repos
   - Portable Layer (`~/.claude/<name>/`): Self-contained packages with their own installers (e.g., GSD)
   - Repo Layer (`.claude/`): Project-specific config committed to each repository

2. **Layer Ownership Rules** (as a table):
   | Layer | Location | Ownership | Examples |
   |-------|----------|-----------|----------|
   | User | `~/.claude/` | Ansible (this repo) | Global CLAUDE.md, base settings.json |
   | Portable | `~/.claude/<name>/` | Package installer | GSD workflows, Context7 |
   | Repo | `.claude/` | Per-repository | Project rules, custom commands |

3. **Current User-Level Structure**
   ```
   ~/.claude/
   ├── settings.json         # Global settings (hooks, permissions)
   ├── CLAUDE.md             # Global instructions (if created)
   ├── commands/             # User-level slash commands
   │   └── gsd/              # GSD namespace (from portable)
   ├── agents/               # User-level subagents
   │   └── gsd-*.md          # GSD agents (from portable)
   ├── hooks/                # Hook scripts
   │   └── *.js              # GSD hooks (from portable)
   └── get-shit-done/        # GSD portable config
       ├── workflows/
       ├── templates/
       └── references/
   ```

4. **When to Use Each Layer**
   - User: Machine-wide defaults (permissions, common tools), shared across all projects
   - Portable: Reusable workflow packages installed via npx, self-updating
   - Repo: Project-specific rules, commands, hooks committed with source code

IMPORTANT: Preserve ALL existing content. Insert the new section between "## Code Style" and "## Nerd Font / Powerline Characters".
  </action>
  <verify>
grep -q "## Claude Code Configuration" CLAUDE.md && grep -q "## Nerd Font / Powerline Characters" CLAUDE.md && grep -q "Three-Layer Architecture" CLAUDE.md
  </verify>
  <done>CLAUDE.md contains complete three-layer architecture documentation before Nerd Font section, all existing content preserved</done>
</task>

<task type="auto">
  <name>Task 2: Create repo-level scaffold with README</name>
  <files>.claude/README.md, .claude/rules/.gitkeep, .claude/commands/.gitkeep, .claude/hooks/.gitkeep</files>
  <action>
Create the repo-level scaffold structure:

1. Create `.claude/README.md` with content explaining:
   - This is the repo-level Claude Code configuration directory
   - Files here apply only to this repository
   - Reference the three layers documented in CLAUDE.md
   - Subdirectory purposes:
     - `rules/` - Project-specific instruction rules (*.md files)
     - `commands/` - Project-specific slash commands
     - `hooks/` - Project-specific hook scripts
   - Note that settings.json and settings.local.json are auto-gitignored

2. Create empty directories with .gitkeep:
   - `.claude/rules/.gitkeep`
   - `.claude/commands/.gitkeep`
   - `.claude/hooks/.gitkeep`

3. Remove the existing `.claude/.gitkeep` (no longer needed with subdirectory .gitkeeps)
  </action>
  <verify>
test -f .claude/README.md && test -f .claude/rules/.gitkeep && test -f .claude/commands/.gitkeep && test -f .claude/hooks/.gitkeep && ! test -f .claude/.gitkeep
  </verify>
  <done>Repo-level .claude/ has clean scaffold with README and empty rules/, commands/, hooks/ directories</done>
</task>

<task type="auto">
  <name>Task 3: Update Ansible playbook to create user-level scaffold</name>
  <files>tools/claude-code/install_claude-code.yml</files>
  <action>
Update the Ansible playbook to ensure user-level scaffold directories exist. Add tasks AFTER "Create Claude config directory" and BEFORE the MCP server tasks:

1. Add task to create scaffold directories:
```yaml
    - name: Create Claude config scaffold directories
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - ~/.claude/commands
        - ~/.claude/agents
        - ~/.claude/hooks
```

This ensures the directories exist even if GSD or other portables aren't installed yet. GSD will populate content, but the structure is owned by Ansible.

The existing "Create Claude config directory" task already handles ~/.claude/ itself.
  </action>
  <verify>
grep -q "Claude config scaffold" tools/claude-code/install_claude-code.yml && grep -q "commands" tools/claude-code/install_claude-code.yml && grep -q "agents" tools/claude-code/install_claude-code.yml && grep -q "hooks" tools/claude-code/install_claude-code.yml
  </verify>
  <done>Ansible playbook creates ~/.claude/commands/, ~/.claude/agents/, ~/.claude/hooks/ directories on deployment</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `grep -A 50 "## Claude Code Configuration" CLAUDE.md` shows complete three-layer documentation
2. `ls -la .claude/` shows README.md and subdirectories (rules/, commands/, hooks/)
3. `ansible-playbook tools/claude-code/install_claude-code.yml --check --diff --connection=local --limit $(hostname -s)` runs without errors
4. All requirements (STRUCT-01 through STRUCT-04) are addressed
</verification>

<success_criteria>
- CLAUDE.md documents three-layer architecture with clear ownership rules
- Repo-level .claude/ has clean scaffold ready for future work
- Ansible playbook creates user-level scaffold directories on deployment
- All existing CLAUDE.md content (especially Nerd Font section) preserved
</success_criteria>

<output>
After completion, create `.planning/phases/02-structure/02-01-SUMMARY.md`
</output>
