---
phase: 03-worktree-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tools/gsd-worktree/gsd-worktree.zsh
  - tools/gsd-worktree/install_gsd-worktree.yml
autonomous: true

must_haves:
  truths:
    - "User can create a worktree with `gsd-worktree-add {name}` and branch is created"
    - "User can list all active worktrees with `gsd-worktree-list`"
    - "User can remove a worktree with `gsd-worktree-remove {name}` (cleans metadata)"
    - "User can squash merge with `gsd-worktree-merge {name}` (checks for conflicts first)"
    - "Worktree directories follow sibling pattern: `../{repo}-{name}/`"
  artifacts:
    - path: "tools/gsd-worktree/gsd-worktree.zsh"
      provides: "Shell functions for worktree management"
      contains: "gsd-worktree-add"
    - path: "tools/gsd-worktree/install_gsd-worktree.yml"
      provides: "Ansible playbook for deployment"
      contains: "blockinfile"
  key_links:
    - from: "install_gsd-worktree.yml"
      to: "~/.zshrc"
      via: "lineinfile source directive"
      pattern: "source.*gsd-worktree.zsh"
    - from: "gsd-worktree.zsh"
      to: "git worktree"
      via: "shell command invocation"
      pattern: "git worktree"
---

<objective>
Create shell commands for git worktree management.

Purpose: Enable users to manage git worktrees through simple shell commands, providing the foundation for parallel feature development in later phases.

Output:
- `tools/gsd-worktree/gsd-worktree.zsh` with 4 functions (add, list, remove, merge) + 2 helpers
- `tools/gsd-worktree/install_gsd-worktree.yml` Ansible playbook for deployment
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-worktree-foundation/03-RESEARCH.md
@tools/git/install_git.yml
@tools/git/git.zsh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gsd-worktree.zsh shell functions</name>
  <files>tools/gsd-worktree/gsd-worktree.zsh</files>
  <action>
Create `tools/gsd-worktree/gsd-worktree.zsh` with the following functions:

1. **gsd-worktree-add** (WT-01, WT-05):
   - Accept name parameter
   - Validate: not empty, in git repo, branch doesn't exist, directory doesn't exist
   - Create worktree at `../{repo}-{name}/` with branch `worktree/{name}`
   - Output success message with cd command hint

2. **gsd-worktree-list** (WT-02):
   - Show worktrees filtered to `worktree/*` branches
   - Display main repo path

3. **gsd-worktree-remove** (WT-03):
   - Accept name parameter
   - Validate worktree exists
   - Use `git worktree remove --force` (not rm -rf)
   - Delete branch with `git branch -D`
   - Run `git worktree prune`

4. **gsd-worktree-merge** (WT-04, WT-06):
   - Accept name parameter
   - Warn if running from linked worktree (not main)
   - Check for uncommitted changes
   - **Conflict detection**: dry-run merge with `--squash --no-commit`, check for unmerged files, abort
   - If conflicts: show conflicting files, abort, return error
   - If no conflicts: perform actual squash merge, prompt for commit

5. **Helper: _gsd-is-main-worktree**:
   - Compare `git rev-parse --git-dir` with `--git-common-dir`
   - Return true if same (main worktree)

6. **Helper: _gsd-worktree-check-conflicts**:
   - Accept branch parameter
   - Try `git merge --squash --no-commit`
   - Check for unmerged files with `git diff --cached --name-only --diff-filter=U`
   - Abort and reset
   - Return exit code indicating conflict status

**Key patterns:**
- All functions use `local` for variables (scope pollution prevention)
- Use `git rev-parse --show-toplevel` for repo root (handles worktrees correctly)
- Output errors to stderr with `>&2`
- Return non-zero on error
- Quote all paths for spaces in repo names

Reference: Complete code examples in `.planning/phases/03-worktree-foundation/03-RESEARCH.md` section "Code Examples"
  </action>
  <verify>
Run `zsh -n tools/gsd-worktree/gsd-worktree.zsh` to check syntax.
Confirm file contains all 4 main functions and 2 helpers.
  </verify>
  <done>
gsd-worktree.zsh exists with syntactically valid Zsh code containing:
- gsd-worktree-add
- gsd-worktree-list
- gsd-worktree-remove
- gsd-worktree-merge
- _gsd-is-main-worktree
- _gsd-worktree-check-conflicts
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Ansible deployment playbook</name>
  <files>tools/gsd-worktree/install_gsd-worktree.yml</files>
  <action>
Create `tools/gsd-worktree/install_gsd-worktree.yml` following the pattern from `tools/git/install_git.yml`:

```yaml
---
- name: Install gsd-worktree shell functions
  hosts: all
  gather_facts: true

  tasks:
    - name: Create zsh config directory
      file:
        path: ~/.config/zsh
        state: directory

    - name: Install gsd-worktree functions
      copy:
        src: gsd-worktree.zsh
        dest: ~/.config/zsh/gsd-worktree.zsh

    - name: Source gsd-worktree in zshrc
      lineinfile:
        path: ~/.zshrc
        line: 'source ~/.config/zsh/gsd-worktree.zsh'
        create: yes
```

This playbook:
- Works on all OS families (no OS-specific tasks needed - pure shell)
- Copies shell functions to `~/.config/zsh/gsd-worktree.zsh`
- Adds source line to `~/.zshrc`
- Is idempotent (lineinfile won't duplicate)
  </action>
  <verify>
Run `ansible-lint tools/gsd-worktree/install_gsd-worktree.yml` to validate.
Run dry-run: `ansible-playbook tools/gsd-worktree/install_gsd-worktree.yml --connection=local --limit $(hostname -s) --check --diff`
  </verify>
  <done>
install_gsd-worktree.yml exists, passes ansible-lint, and dry-run shows correct changes (create zsh config dir, copy file, add source line).
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Syntax check:**
   ```bash
   zsh -n tools/gsd-worktree/gsd-worktree.zsh
   ansible-lint tools/gsd-worktree/install_gsd-worktree.yml
   ```

2. **Functional test (in a test repo):**
   ```bash
   # Source functions
   source tools/gsd-worktree/gsd-worktree.zsh

   # Test add
   gsd-worktree-add test-feature
   # Should create ../$(basename $(pwd))-test-feature/

   # Test list
   gsd-worktree-list
   # Should show the new worktree

   # Test remove
   gsd-worktree-remove test-feature
   # Should remove worktree and branch
   ```

3. **Requirements coverage:**
   - WT-01: gsd-worktree-add creates worktree with branch
   - WT-02: gsd-worktree-list shows worktrees
   - WT-03: gsd-worktree-remove cleans up fully
   - WT-04: gsd-worktree-merge performs squash merge
   - WT-05: Sibling naming convention in add function
   - WT-06: Conflict detection in merge function
</verification>

<success_criteria>
Phase 3 is complete when:
- [ ] `tools/gsd-worktree/gsd-worktree.zsh` contains all 4 main functions + 2 helpers
- [ ] `tools/gsd-worktree/install_gsd-worktree.yml` passes ansible-lint
- [ ] Functional test of add/list/remove cycle works
- [ ] All 6 WT requirements are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-worktree-foundation/03-01-SUMMARY.md`
</output>
