---
phase: 04-hook-registration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/settings.local.json
autonomous: true

must_haves:
  truths:
    - "Editing a YAML file in _dotfiles triggers ansible-lint automatically"
    - "Lint errors appear in Claude Code output"
    - "Clean files produce no output (silent success)"
  artifacts:
    - path: ".claude/settings.local.json"
      provides: "Hook registration for ansible-lint"
      contains: "PostToolUse"
  key_links:
    - from: ".claude/settings.local.json"
      to: "~/.claude/hooks/ansible-lint.sh"
      via: "hooks.PostToolUse command reference"
      pattern: "ansible-lint\\.sh"
---

<objective>
Register the ansible-lint hook in the _dotfiles repo-level settings.

Purpose: Complete TOOL-01 and TOOL-02 requirements by wiring the already-deployed hook script to Claude Code's PostToolUse trigger. The hook exists at `~/.claude/hooks/ansible-lint.sh` but is not invoked because no settings.json entry tells Claude Code to run it.

Output: Updated `.claude/settings.local.json` with hooks configuration that triggers ansible-lint on Edit/Write operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing repo-level settings (must preserve permissions)
@.claude/settings.local.json

# The hook script that needs to be registered (already deployed)
@tools/claude-code/hooks/ansible-lint.sh

# Current global settings showing hook structure
# ~/.claude/settings.json has GSD hooks in PostToolUse - our repo hook extends these
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PostToolUse hook registration to settings.local.json</name>
  <files>.claude/settings.local.json</files>
  <action>
Add a `hooks` section to the existing `.claude/settings.local.json` that registers the ansible-lint hook for PostToolUse events matching Edit or Write tools.

The file currently contains only a `permissions` object. Add a sibling `hooks` object with this structure:

```json
{
  "permissions": { ... existing permissions ... },
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "bash \"$HOME/.claude/hooks/ansible-lint.sh\""
          }
        ]
      }
    ]
  }
}
```

Key points:
- Preserve all existing permissions entries exactly
- Use `matcher: "Edit|Write"` to filter to file modification events only
- Use `bash` explicitly to invoke the shell script
- Use `$HOME` environment variable (not hardcoded path)
- The hook script already handles:
  - Skipping if not in _dotfiles repo
  - Skipping if ansible-lint not available
  - Finding recently modified .yml files
  - Silent success when no errors
  </action>
  <verify>
1. Validate JSON syntax: `cat .claude/settings.local.json | jq .`
2. Confirm hooks section exists: `jq '.hooks.PostToolUse' .claude/settings.local.json`
3. Confirm permissions preserved: `jq '.permissions.allow | length' .claude/settings.local.json` (should be > 0)
  </verify>
  <done>
`.claude/settings.local.json` contains valid JSON with both `permissions` and `hooks` sections. The PostToolUse hook references `ansible-lint.sh` with Edit|Write matcher.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify E2E hook trigger</name>
  <files>None (verification only)</files>
  <action>
Test the complete flow by making a trivial edit to a YAML file and observing the hook output.

Steps:
1. Make a whitespace-only change to any .yml file (e.g., add/remove a blank line in `setup.yml`)
2. The Edit/Write tool use should trigger the PostToolUse hook
3. If the file has lint errors, they appear in output
4. If the file is clean, hook exits silently (no output)

To verify the hook is being invoked (even if it exits silently), you can:
1. Check that the Edit/Write operation completes normally
2. If testing on a file with known lint issues, errors should appear

Note: The hook script already checks `[[ "$PWD" != *"_dotfiles"* ]]` so it only runs in this repo. The hook also checks for `ansible-lint` availability.
  </action>
  <verify>
1. Edit a .yml file - operation completes without error
2. If file had lint violations, errors appear in output
3. If file was clean, no error output (silent success)

For explicit verification, temporarily introduce a lint error:
```bash
# Add a bare module name (FQCN violation) to test
echo "  - name: Test lint\n    file: path=/tmp/test state=directory" >> /tmp/test-lint.yml
```
Then edit a real file and observe the hook behavior.
  </verify>
  <done>
Hook triggers on Edit/Write operations. Lint errors are reported when present. Clean files produce no output.
  </done>
</task>

</tasks>

<verification>
Phase 4 is complete when:
1. `.claude/settings.local.json` contains PostToolUse hook for ansible-lint
2. JSON is valid and existing permissions are preserved
3. Hook fires on YAML file edits in _dotfiles repo
4. Lint errors appear in Claude Code output when present
</verification>

<success_criteria>
- [ ] `jq '.hooks.PostToolUse[0].matcher' .claude/settings.local.json` returns "Edit|Write"
- [ ] `jq '.hooks.PostToolUse[0].hooks[0].command' .claude/settings.local.json` contains "ansible-lint.sh"
- [ ] Editing a .yml file triggers the hook (observable in Claude Code session)
- [ ] TOOL-01 and TOOL-02 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-hook-registration/04-01-SUMMARY.md` with:
- Implementation details
- Verification results
- Any issues encountered
</output>
