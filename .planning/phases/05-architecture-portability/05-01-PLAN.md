---
phase: 05-architecture-portability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tools/docker/install_docker.yml
  - tools/go/install_go.yml
autonomous: true

must_haves:
  truths:
    - "Docker repository URL uses detected system architecture (amd64 or arm64)"
    - "Go download URL uses detected OS and architecture combination"
    - "Playbooks run without modification on both x86_64 and ARM64 systems"
  artifacts:
    - path: "tools/docker/install_docker.yml"
      provides: "Dynamic architecture detection for Docker APT repository"
      contains: "deb_arch_map"
    - path: "tools/go/install_go.yml"
      provides: "Dynamic OS and architecture detection for Go downloads"
      contains: "go_arch_map"
  key_links:
    - from: "tools/docker/install_docker.yml"
      to: "ansible_facts.architecture"
      via: "deb_arch_map dictionary lookup"
      pattern: "deb_arch_map\\[ansible_facts.architecture\\]"
    - from: "tools/go/install_go.yml"
      to: "ansible_facts.architecture"
      via: "go_arch_map dictionary lookup"
      pattern: "go_arch_map\\[ansible_facts.architecture\\]"
---

<objective>
Add dynamic architecture detection to Docker and Go playbooks so they work on both x86_64 and ARM64 systems.

Purpose: Enable Raspberry Pi (ARM64 Debian) support without hardcoded architecture values.
Output: Updated playbooks with architecture mapping dictionaries that resolve arch from ansible_facts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-architecture-portability/05-RESEARCH.md

Reference files:
@tools/docker/install_docker.yml
@tools/go/install_go.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add architecture mapping to Docker playbook</name>
  <files>tools/docker/install_docker.yml</files>
  <action>
Add a `vars:` section after `gather_facts: true` with architecture mapping dictionary:

```yaml
vars:
  deb_arch_map:
    x86_64: amd64
    aarch64: arm64
  deb_arch: "{{ deb_arch_map[ansible_facts.architecture] }}"
```

Then update the "Add Docker repository (Debian)" task to use dynamic arch:
- Change: `arch=amd64`
- To: `arch={{ deb_arch }}`

The full repo line becomes:
```yaml
repo: "deb [arch={{ deb_arch }} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
```

Docker officially supports both amd64 and arm64 repositories.
  </action>
  <verify>Run `ansible-lint tools/docker/install_docker.yml` - should pass with no errors</verify>
  <done>Docker playbook has deb_arch_map vars and uses {{ deb_arch }} in repository URL</done>
</task>

<task type="auto">
  <name>Task 2: Add architecture mapping to Go playbook</name>
  <files>tools/go/install_go.yml</files>
  <action>
Expand the existing `vars:` section to include OS and architecture mappings:

```yaml
vars:
  go_version: "1.23.4"
  go_os_map:
    Darwin: darwin
    Debian: linux
    Archlinux: linux
  go_arch_map:
    x86_64: amd64
    aarch64: arm64
  go_os: "{{ go_os_map[ansible_facts.os_family] }}"
  go_arch: "{{ go_arch_map[ansible_facts.architecture] }}"
```

Update the download tasks:

1. Find the "Download Go installer (macOS)" task and change URL from hardcoded `darwin-arm64` to dynamic:
   ```yaml
   url: "https://go.dev/dl/go{{ go_version }}.{{ go_os }}-{{ go_arch }}.pkg"
   ```

2. Find the "Download Go tarball (Linux)" task and change URL from hardcoded `linux-amd64` to dynamic:
   ```yaml
   url: "https://go.dev/dl/go{{ go_version }}.{{ go_os }}-{{ go_arch }}.tar.gz"
   ```

This handles:
- macOS x86_64: darwin-amd64.pkg
- macOS ARM64: darwin-arm64.pkg
- Linux x86_64: linux-amd64.tar.gz
- Linux ARM64: linux-arm64.tar.gz
  </action>
  <verify>Run `ansible-lint tools/go/install_go.yml` - should pass with no errors</verify>
  <done>Go playbook uses dynamic go_os and go_arch variables for download URLs on all platforms</done>
</task>

</tasks>

<verification>
1. `ansible-lint tools/docker/install_docker.yml` passes
2. `ansible-lint tools/go/install_go.yml` passes
3. `grep -r "arch=amd64" tools/docker/` returns no matches
4. `grep -r "linux-amd64\|darwin-arm64" tools/go/` returns no matches (hardcoded values removed)
5. `grep "deb_arch_map" tools/docker/install_docker.yml` returns match
6. `grep "go_arch_map" tools/go/install_go.yml` returns match
</verification>

<success_criteria>
- Docker playbook has architecture mapping dictionary in vars
- Docker apt_repository uses {{ deb_arch }} instead of hardcoded amd64
- Go playbook has both OS and architecture mapping dictionaries
- Go download URLs use {{ go_os }}-{{ go_arch }} pattern
- Both playbooks pass ansible-lint
- No hardcoded architecture strings remain in either file
</success_criteria>

<output>
After completion, create `.planning/phases/05-architecture-portability/05-01-SUMMARY.md`
</output>
