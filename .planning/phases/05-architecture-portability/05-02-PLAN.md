---
phase: 05-architecture-portability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tools/1password/install_1password.yml
  - tools/edge/install_edge.yml
autonomous: true

must_haves:
  truths:
    - "1Password installation skips on ARM64 Debian with informative debug message"
    - "Edge installation skips on ARM64 Debian with informative debug message"
    - "Playbooks complete successfully on ARM64 without errors"
  artifacts:
    - path: "tools/1password/install_1password.yml"
      provides: "Architecture-conditional installation with ARM64 skip"
      contains: "ansible_facts.architecture == 'x86_64'"
    - path: "tools/edge/install_edge.yml"
      provides: "Architecture-conditional installation with ARM64 skip"
      contains: "ansible_facts.architecture == 'x86_64'"
  key_links:
    - from: "tools/1password/install_1password.yml"
      to: "ansible_facts.architecture"
      via: "when conditional"
      pattern: "architecture == ['\"]x86_64['\"]"
    - from: "tools/edge/install_edge.yml"
      to: "ansible_facts.architecture"
      via: "when conditional"
      pattern: "architecture == ['\"]x86_64['\"]"
---

<objective>
Add architecture conditionals to 1Password and Edge playbooks so they gracefully skip on ARM64 systems.

Purpose: Neither 1Password nor Edge provide ARM64 APT repositories. Rather than failing, playbooks should skip with informative messages on ARM64 Debian.
Output: Updated playbooks that check architecture before attempting x86_64-only installations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-architecture-portability/05-RESEARCH.md

Reference files:
@tools/1password/install_1password.yml
@tools/edge/install_edge.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add architecture conditional to 1Password playbook</name>
  <files>tools/1password/install_1password.yml</files>
  <action>
Modify the Debian tasks to only run on x86_64 architecture:

1. Find the "Add 1Password apt repository (Debian)" task and add architecture check to the when clause:
   ```yaml
   when:
     - ansible_facts['os_family'] == "Debian"
     - ansible_facts.architecture == "x86_64"
     - not onepassword_check.stat.exists
   ```

2. Find the "Install 1Password via apt (Debian)" task and add architecture check to the when clause:
   ```yaml
   when:
     - ansible_facts['os_family'] == "Debian"
     - ansible_facts.architecture == "x86_64"
   ```

3. Add a new debug task AFTER the apt install task to inform ARM64 users:
   ```yaml
   - name: Skip 1Password on ARM64 (no APT repository available)
     ansible.builtin.debug:
       msg: "1Password APT repository not available for ARM64. Manual installation: https://downloads.1password.com/linux/tar/stable/aarch64/"
     when:
       - ansible_facts['os_family'] == "Debian"
       - ansible_facts.architecture == "aarch64"
   ```

The macOS and Arch tasks remain unchanged (macOS uses Homebrew, Arch uses yay which handles arch).
  </action>
  <verify>Run `ansible-lint tools/1password/install_1password.yml` - should pass with no errors</verify>
  <done>1Password Debian tasks have x86_64 architecture check and ARM64 skip message</done>
</task>

<task type="auto">
  <name>Task 2: Add architecture conditional to Edge playbook</name>
  <files>tools/edge/install_edge.yml</files>
  <action>
Modify the Debian tasks to only run on x86_64 architecture:

1. Find the "Add Microsoft Edge apt repository (Debian)" task and add architecture check to the when clause:
   ```yaml
   when:
     - ansible_facts['os_family'] == "Debian"
     - ansible_facts.architecture == "x86_64"
     - not edge_check.stat.exists
   ```

2. Find the "Install Microsoft Edge via apt (Debian)" task and add architecture check to the when clause:
   ```yaml
   when:
     - ansible_facts['os_family'] == "Debian"
     - ansible_facts.architecture == "x86_64"
   ```

3. Add a new debug task AFTER the apt install task to inform ARM64 users:
   ```yaml
   - name: Skip Edge on ARM64 (no Linux packages available)
     ansible.builtin.debug:
       msg: "Microsoft Edge is not available for ARM64 Linux. No alternative installation method exists."
     when:
       - ansible_facts['os_family'] == "Debian"
       - ansible_facts.architecture == "aarch64"
   ```

The macOS and Arch tasks remain unchanged (macOS uses Homebrew, Arch uses yay).
  </action>
  <verify>Run `ansible-lint tools/edge/install_edge.yml` - should pass with no errors</verify>
  <done>Edge Debian tasks have x86_64 architecture check and ARM64 skip message</done>
</task>

</tasks>

<verification>
1. `ansible-lint tools/1password/install_1password.yml` passes
2. `ansible-lint tools/edge/install_edge.yml` passes
3. `grep "x86_64" tools/1password/install_1password.yml` returns matches for architecture checks
4. `grep "x86_64" tools/edge/install_edge.yml` returns matches for architecture checks
5. `grep "aarch64" tools/1password/install_1password.yml` returns match for debug task
6. `grep "aarch64" tools/edge/install_edge.yml` returns match for debug task
</verification>

<success_criteria>
- 1Password Debian tasks have `ansible_facts.architecture == "x86_64"` in when clauses
- 1Password has debug message for ARM64 users with manual install link
- Edge Debian tasks have `ansible_facts.architecture == "x86_64"` in when clauses
- Edge has debug message for ARM64 users
- Both playbooks pass ansible-lint
- Running on ARM64 Debian would skip installations gracefully (not fail)
</success_criteria>

<output>
After completion, create `.planning/phases/05-architecture-portability/05-02-SUMMARY.md`
</output>
