---
phase: 06-idempotency-guards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tools/go/install_go.yml
  - tools/python/install_python.yml
autonomous: true

must_haves:
  truths:
    - "Mason install task skips when typescript-language-server binary exists (IDEM-02)"
    - "npm install -g tasks skip when tsc binary exists (IDEM-03)"
    - "Go dev tools task skips when gofumpt binary exists (IDEM-01)"
    - "Python dev tools tasks skip when ruff binary exists (IDEM-04)"
    - "Re-running playbooks shows changed=0 for guarded tasks (IDEM-05)"
  artifacts:
    - path: "tools/neovim/install_neovim.yml"
      provides: "creates guard for Mason packages"
      contains: "creates: ~/.local/share/nvim/mason/bin/typescript-language-server"
    - path: "tools/node/install_node.yml"
      provides: "creates guard for npm global packages"
      contains: "creates: ~/.nvm/versions/node/*/bin/tsc"
    - path: "tools/go/install_go.yml"
      provides: "creates guard for Go dev tools"
      contains: "creates: ~/go/bin/gofumpt"
    - path: "tools/python/install_python.yml"
      provides: "creates guards for Python dev tools"
      contains: "creates: ~/.local/bin/ruff"
  key_links:
    - from: "creates: guard"
      to: "shell task"
      via: "args block"
      pattern: "args:\\s+creates:"
---

<objective>
Add idempotency guards to shell-based tool installations so re-runs show zero false "changed" status.

Purpose: Ansible playbook re-runs should be truly idempotent - tasks that install binaries should skip when those binaries already exist, eliminating noise in ansible-playbook output.

Output: Two playbook files with `creates:` guards that check for installed binaries before running shell commands.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-idempotency-guards/06-RESEARCH.md

# Source files
@tools/go/install_go.yml
@tools/python/install_python.yml

# Reference patterns (already have correct guards)
@tools/yamlfmt/install_yamlfmt.yml
@tools/tldr/install_tldr.yml
</context>

<tasks>

<task type="auto">
  <name>Task 0: Verify IDEM-02 and IDEM-03 are already guarded</name>
  <files></files>
  <action>
Verify that Mason and npm global packages already have creates guards in place.

Check IDEM-02 (Mason) in install_neovim.yml:
```bash
grep -A1 "args:" tools/neovim/install_neovim.yml | grep "creates:.*mason"
```
Expected: `creates: ~/.local/share/nvim/mason/bin/typescript-language-server`

Check IDEM-03 (npm) in install_node.yml:
```bash
grep -A1 "args:" tools/node/install_node.yml | grep "creates:.*nvm.*tsc"
```
Expected: `creates: ~/.nvm/versions/node/*/bin/tsc` (appears twice, for macOS and Linux)

Document findings: These guards were added in prior work and are correctly implemented per the research documentation.
  </action>
  <verify>
Grep commands return expected creates guard patterns for both files.
  </verify>
  <done>
IDEM-02 (Mason) confirmed: install_neovim.yml has `creates: ~/.local/share/nvim/mason/bin/typescript-language-server`
IDEM-03 (npm) confirmed: install_node.yml has `creates: ~/.nvm/versions/node/*/bin/tsc` for both OS variants
  </done>
</task>

<task type="auto">
  <name>Task 1: Add creates guard to Go dev tools</name>
  <files>tools/go/install_go.yml</files>
  <action>
Add `args:` block with `creates: ~/go/bin/gofumpt` to the "Install Go dev tools" task (lines 57-62).

The task currently runs unconditionally:
```yaml
- name: Install Go dev tools
  ansible.builtin.shell: |
    export PATH=$PATH:/usr/local/go/bin
    go install mvdan.cc/gofumpt@latest
    go install golang.org/x/tools/cmd/goimports@latest
    go install golang.org/x/tools/gopls@latest
```

Add the guard after the shell block:
```yaml
- name: Install Go dev tools
  ansible.builtin.shell: |
    export PATH=$PATH:/usr/local/go/bin
    go install mvdan.cc/gofumpt@latest
    go install golang.org/x/tools/cmd/goimports@latest
    go install golang.org/x/tools/gopls@latest
  args:
    creates: ~/go/bin/gofumpt
```

Note: Guarding on gofumpt (the first installed binary) is sufficient since these tools are always installed together.
  </action>
  <verify>
Run `ansible-lint tools/go/install_go.yml` - should pass with no errors.
Grep for the guard: `grep -A1 "args:" tools/go/install_go.yml` should show "creates: ~/go/bin/gofumpt"
  </verify>
  <done>
The "Install Go dev tools" task has an `args: creates:` block that checks for ~/go/bin/gofumpt before running.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add creates guards to Python dev tools</name>
  <files>tools/python/install_python.yml</files>
  <action>
Add `args:` block with `creates: ~/.local/bin/ruff` to BOTH Python dev tools tasks (macOS and Linux).

Current tasks (lines 19-25):
```yaml
- name: Install Python dev tools (macOS)
  ansible.builtin.shell: /opt/homebrew/bin/uv tool install ruff && /opt/homebrew/bin/uv tool install black && /opt/homebrew/bin/uv tool install isort
  when: ansible_facts['os_family'] == "Darwin"

- name: Install Python dev tools (Linux)
  ansible.builtin.shell: ~/.local/bin/uv tool install ruff && ~/.local/bin/uv tool install black && ~/.local/bin/uv tool install isort
  when: ansible_facts['os_family'] in ["Debian", "Archlinux"]
```

Add guards to both:
```yaml
- name: Install Python dev tools (macOS)
  ansible.builtin.shell: /opt/homebrew/bin/uv tool install ruff && /opt/homebrew/bin/uv tool install black && /opt/homebrew/bin/uv tool install isort
  args:
    creates: ~/.local/bin/ruff
  when: ansible_facts['os_family'] == "Darwin"

- name: Install Python dev tools (Linux)
  ansible.builtin.shell: ~/.local/bin/uv tool install ruff && ~/.local/bin/uv tool install black && ~/.local/bin/uv tool install isort
  args:
    creates: ~/.local/bin/ruff
  when: ansible_facts['os_family'] in ["Debian", "Archlinux"]
```

Note: uv symlinks tool binaries to ~/.local/bin regardless of OS, so the guard path is the same for both.
  </action>
  <verify>
Run `ansible-lint tools/python/install_python.yml` - should pass with no errors.
Grep for guards: `grep -A1 "args:" tools/python/install_python.yml` should show "creates: ~/.local/bin/ruff" twice.
  </verify>
  <done>
Both Python dev tools tasks have `args: creates:` blocks checking for ~/.local/bin/ruff before running.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify idempotency with dry-run</name>
  <files></files>
  <action>
Run a check-mode playbook execution to verify the guards work correctly.

If the binaries already exist on the local machine:
```bash
ansible-playbook tools/go/install_go.yml --connection=local --limit $(hostname -s) --check --diff
ansible-playbook tools/python/install_python.yml --connection=local --limit $(hostname -s) --check --diff
```

Look for "skipping" or "ok" status (not "changed") on the dev tools tasks.

If binaries don't exist locally, verify by reading the playbook and confirming the `creates:` argument is correctly structured per Ansible documentation.
  </action>
  <verify>
The playbook check runs complete without errors. Tasks with `creates:` guards show appropriate status based on binary existence.
  </verify>
  <done>
Playbooks pass ansible-lint and check-mode execution confirms guards are correctly applied.
  </done>
</task>

</tasks>

<verification>
1. `ansible-lint tools/go/install_go.yml` passes
2. `ansible-lint tools/python/install_python.yml` passes
3. Each modified task has `args: creates:` with the correct binary path
4. Guard paths match documented patterns:
   - Go: `~/go/bin/<binary>`
   - uv: `~/.local/bin/<binary>`
5. IDEM-02 (Mason) and IDEM-03 (npm) confirmed as already guarded
</verification>

<success_criteria>
- IDEM-01: Go install task has `creates: ~/go/bin/gofumpt`
- IDEM-02: Mason install task confirmed to have `creates: ~/.local/share/nvim/mason/bin/typescript-language-server` (pre-existing)
- IDEM-03: npm install tasks confirmed to have `creates: ~/.nvm/versions/node/*/bin/tsc` (pre-existing)
- IDEM-04: Python dev tools tasks have `creates: ~/.local/bin/ruff`
- IDEM-05: Re-runs show changed=0 for guarded tasks (verified via check mode)
- All playbooks pass ansible-lint
</success_criteria>

<output>
After completion, create `.planning/phases/06-idempotency-guards/06-01-SUMMARY.md`
</output>
