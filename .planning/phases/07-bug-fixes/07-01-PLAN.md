---
phase: 07-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tools/ssh/install_ssh.yml
autonomous: true

must_haves:
  truths:
    - "SSH known_hosts task checks host presence before adding"
    - "Re-running SSH playbook does not add duplicate entries"
    - "Marker file pattern is removed"
  artifacts:
    - path: "tools/ssh/install_ssh.yml"
      provides: "Idempotent known_hosts management"
      contains: "ssh-keygen -F"
  key_links:
    - from: "ssh-keygen -F check"
      to: "ssh-keyscan append"
      via: "when: item.rc != 0 conditional"
      pattern: "when:.*rc != 0"
---

<objective>
Fix SSH known_hosts duplicate entries bug by replacing marker file pattern with ssh-keygen -F verification.

Purpose: Ensure re-running SSH playbook is truly idempotent - hosts already in known_hosts are not re-added
Output: Updated install_ssh.yml with proper host presence verification
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-bug-fixes/07-RESEARCH.md
@tools/ssh/install_ssh.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace marker file pattern with ssh-keygen -F check</name>
  <files>tools/ssh/install_ssh.yml</files>
  <action>
Replace lines 55-75 (the two tasks: "Add host keys to known_hosts" and "Mark known_hosts as populated") with the ssh-keygen -F pattern from research:

1. Remove the existing "Add host keys to known_hosts" task (lines 55-64)
2. Remove the "Mark known_hosts as populated" task (lines 66-75)
3. Add two new tasks:

```yaml
    - name: Check if hosts already in known_hosts
      ansible.builtin.shell: ssh-keygen -F {{ item }}.home.lan
      register: known_hosts_check
      changed_when: false
      failed_when: false
      loop:
        - macbookair
        - macmini
        - desktop
        - miniserver

    - name: Add missing host keys to known_hosts
      ansible.builtin.shell: ssh-keyscan -H {{ item.item }}.home.lan >> ~/.ssh/known_hosts 2>/dev/null
      loop: "{{ known_hosts_check.results }}"
      loop_control:
        label: "{{ item.item }}"
      when: item.rc != 0
      ignore_errors: true
```

Key differences from old pattern:
- No `creates:` argument (ssh-keygen -F IS the idempotency mechanism)
- No marker file touch task
- Uses `register` + `when: item.rc != 0` to conditionally add only missing hosts
- `loop_control: label` for cleaner output
  </action>
  <verify>
Run ansible-lint on the file:
```bash
ansible-lint tools/ssh/install_ssh.yml
```
Verify no errors related to the modified tasks.
  </verify>
  <done>
- ssh-keygen -F check task exists
- Conditional ssh-keyscan task uses `when: item.rc != 0`
- No marker file tasks remain
- ansible-lint passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify idempotency logic</name>
  <files>tools/ssh/install_ssh.yml</files>
  <action>
Run a dry-run check to verify the playbook structure is valid:

```bash
ansible-playbook tools/ssh/install_ssh.yml --connection=local --limit $(hostname -s) --check --diff
```

This verifies:
1. YAML syntax is correct
2. Task references are valid (known_hosts_check.results exists)
3. Loop control syntax is correct

Note: The check may show "changed" for ssh-keyscan tasks since --check mode cannot actually run ssh-keygen -F to populate the register. This is expected. The key is that the playbook runs without errors.
  </action>
  <verify>
Dry-run completes without syntax or task errors:
```bash
ansible-playbook tools/ssh/install_ssh.yml --connection=local --limit $(hostname -s) --check --diff 2>&1 | tail -20
```
  </verify>
  <done>
- Playbook runs in check mode without errors
- No YAML syntax issues
- Task structure is valid
  </done>
</task>

</tasks>

<verification>
1. `ansible-lint tools/ssh/install_ssh.yml` passes
2. No marker file pattern (`creates: ~/.ssh/.known_hosts_`) in file
3. `ssh-keygen -F` check exists before ssh-keyscan
4. Conditional `when: item.rc != 0` gates the append operation
</verification>

<success_criteria>
- BUG-01 requirement satisfied: SSH known_hosts uses ssh-keygen -F to verify host presence
- Re-running playbook will not add duplicate entries (ssh-keygen -F returns 0 for existing hosts)
- Marker file tasks removed (cleaner, no orphaned .known_hosts_* files)
</success_criteria>

<output>
After completion, create `.planning/phases/07-bug-fixes/07-01-SUMMARY.md`
</output>
