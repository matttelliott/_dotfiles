---
phase: 07-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tools/gpu/install_gpu.yml
autonomous: true

must_haves:
  truths:
    - "Debian non-free repos added via deb822_repository module"
    - "No sed manipulation of sources.list"
    - "apt cache updated after repo addition"
  artifacts:
    - path: "tools/gpu/install_gpu.yml"
      provides: "Safe Debian non-free repository management"
      contains: "deb822_repository"
  key_links:
    - from: "deb822_repository task"
      to: "apt update_cache task"
      via: "sequential execution"
      pattern: "update_cache: true"
---

<objective>
Fix Debian non-free repository bug by replacing fragile sed pattern with deb822_repository module.

Purpose: Ensure Debian non-free repo addition is declarative, safe, and idempotent - no risk of corrupting sources.list
Output: Updated install_gpu.yml using modern Ansible repository management
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-bug-fixes/07-RESEARCH.md
@tools/gpu/install_gpu.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace sed pattern with deb822_repository module</name>
  <files>tools/gpu/install_gpu.yml</files>
  <action>
Replace lines 104-122 (the three tasks: "Check if non-free repos enabled", "Enable non-free and contrib repos", and "Update apt cache after enabling non-free") with the deb822_repository pattern from research:

1. Remove the existing "Check if non-free repos enabled (Debian)" task (lines 105-109)
2. Remove the "Enable non-free and contrib repos (Debian)" task (lines 111-116)
3. Remove the "Update apt cache after enabling non-free (Debian)" task (lines 118-122)
4. Add two new tasks (keep the comment "# Debian - Enable non-free repos for NVIDIA"):

```yaml
    # Debian - Enable non-free repos for NVIDIA
    - name: Add Debian non-free repository for NVIDIA (Debian)
      ansible.builtin.deb822_repository:
        name: debian-nonfree
        types: deb
        uris: https://deb.debian.org/debian
        suites: "{{ ansible_distribution_release }}"
        components:
          - contrib
          - non-free
          - non-free-firmware
        state: present
      become: true
      when: ansible_facts['os_family'] == "Debian" and has_nvidia | default(false)

    - name: Update apt cache after adding non-free repo (Debian)
      ansible.builtin.apt:
        update_cache: true
      become: true
      when: ansible_facts['os_family'] == "Debian" and has_nvidia | default(false)
```

Key differences from old pattern:
- No grep check (deb822_repository is inherently idempotent)
- No sed manipulation (module manages /etc/apt/sources.list.d/debian-nonfree.sources)
- Uses `ansible_distribution_release` fact for Debian release name (e.g., bookworm)
- Includes all three components: contrib, non-free, non-free-firmware (for Debian 12+)
- apt cache update always runs when NVIDIA detected (module handles changed state correctly)
  </action>
  <verify>
Run ansible-lint on the file:
```bash
ansible-lint tools/gpu/install_gpu.yml
```
Verify no errors related to the modified tasks.
  </verify>
  <done>
- deb822_repository task exists with correct parameters
- No grep/sed tasks for non-free repos
- apt update_cache task follows repo addition
- ansible-lint passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify playbook structure</name>
  <files>tools/gpu/install_gpu.yml</files>
  <action>
Run a dry-run check to verify the playbook structure is valid:

```bash
ansible-playbook tools/gpu/install_gpu.yml --connection=local --limit $(hostname -s) --check --diff
```

This verifies:
1. YAML syntax is correct
2. Module parameters are valid
3. Conditional logic is correct

Note: On non-Debian systems or systems without NVIDIA, the deb822_repository task will be skipped. On Arch Linux (which this machine likely runs), the Debian-specific tasks will all be skipped.
  </action>
  <verify>
Dry-run completes without syntax or module errors:
```bash
ansible-playbook tools/gpu/install_gpu.yml --connection=local --limit $(hostname -s) --check --diff 2>&1 | tail -30
```
  </verify>
  <done>
- Playbook runs in check mode without errors
- No YAML syntax issues
- Module parameters are valid
  </done>
</task>

</tasks>

<verification>
1. `ansible-lint tools/gpu/install_gpu.yml` passes
2. No sed pattern (`sed -i`) in file for sources.list
3. No grep check for non-free in file
4. `deb822_repository` module used with correct parameters
5. apt update_cache follows repo addition
</verification>

<success_criteria>
- BUG-02 requirement satisfied: Debian non-free repos use apt_repository module (specifically deb822_repository)
- Running playbook twice shows correct changed/ok status (no false positives)
- sources.list is not modified (repo added as separate file in sources.list.d/)
</success_criteria>

<output>
After completion, create `.planning/phases/07-bug-fixes/07-02-SUMMARY.md`
</output>
