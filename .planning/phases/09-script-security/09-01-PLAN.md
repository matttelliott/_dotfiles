---
phase: 09-script-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bootstrap.sh
  - tools/homebrew/install_homebrew.yml
  - tools/pulumi/install_pulumi.yml
  - tools/python/install_python.yml
  - tools/rust/install_rust.yml
  - tools/starship/install_starship.yml
autonomous: true

must_haves:
  truths:
    - "All curl-piped scripts reference specific versions, not HEAD/master"
    - "Scripts that cannot be pinned have explicit security comments"
    - "ansible-lint still passes after changes"
  artifacts:
    - path: "bootstrap.sh"
      provides: "Pinned Homebrew installer URL"
      contains: "Homebrew/install/90fa3d5"
    - path: "tools/homebrew/install_homebrew.yml"
      provides: "Pinned Homebrew installer URL"
      contains: "Homebrew/install/90fa3d5"
    - path: "tools/pulumi/install_pulumi.yml"
      provides: "Pinned Pulumi version"
      contains: "--version"
    - path: "tools/python/install_python.yml"
      provides: "Pinned uv version URL"
      contains: "astral.sh/uv/0."
    - path: "tools/rust/install_rust.yml"
      provides: "Security comment explaining no pinning"
      contains: "cannot be pinned"
    - path: "tools/starship/install_starship.yml"
      provides: "Security comment explaining no pinning"
      contains: "cannot be pinned"
  key_links:
    - from: "bootstrap.sh"
      to: "Homebrew/install repo"
      via: "commit SHA in URL"
      pattern: "Homebrew/install/[a-f0-9]{40}/install\\.sh"
---

<objective>
Pin curl-to-shell installation scripts to specific versions or commits.

Purpose: Prevent supply chain attacks where malicious code is injected into HEAD/master branches. Version pinning makes script contents auditable and reproducible.

Output: 6 updated playbooks with pinned URLs or security comments for scripts that cannot be pinned.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-script-security/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pin Homebrew installer to commit SHA</name>
  <files>bootstrap.sh, tools/homebrew/install_homebrew.yml</files>
  <action>
Update Homebrew curl-pipe URLs from HEAD to specific commit:

**bootstrap.sh (line 159):**
Change:
```bash
NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```
To:
```bash
# Homebrew installer pinned to commit 90fa3d5881cedc0d60c4a3cc5babdb867ef42e5a (2026-01-23)
# Verify/update at: https://github.com/Homebrew/install/commits/master
NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/90fa3d5881cedc0d60c4a3cc5babdb867ef42e5a/install.sh)"
```

**tools/homebrew/install_homebrew.yml (line 21):**
Change the shell command URL similarly and add a comment above the task:
```yaml
    - name: Install Homebrew
      # Homebrew installer pinned to commit 90fa3d5881cedc0d60c4a3cc5babdb867ef42e5a (2026-01-23)
      # Verify/update at: https://github.com/Homebrew/install/commits/master
      ansible.builtin.shell: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/90fa3d5881cedc0d60c4a3cc5babdb867ef42e5a/install.sh)"
```
  </action>
  <verify>grep -r "Homebrew/install/90fa3d5" bootstrap.sh tools/homebrew/</verify>
  <done>Both files reference commit SHA 90fa3d5881cedc0d60c4a3cc5babdb867ef42e5a instead of HEAD</done>
</task>

<task type="auto">
  <name>Task 2: Pin Pulumi and uv installers with version flags</name>
  <files>tools/pulumi/install_pulumi.yml, tools/python/install_python.yml</files>
  <action>
**tools/pulumi/install_pulumi.yml:**
Update the Linux installer to use `--version` flag:
```yaml
    - name: Install Pulumi via official installer (Linux)
      # Pulumi installer with pinned version (update periodically)
      # Latest version: https://github.com/pulumi/pulumi/releases
      ansible.builtin.shell: curl -fsSL https://get.pulumi.com | sh -s -- --version 3.216.0
      args:
        creates: ~/.pulumi/bin/pulumi
      when: ansible_facts['os_family'] in ["Debian", "Archlinux"]
```

**tools/python/install_python.yml:**
Update the Linux installer to use versioned URL:
```yaml
    - name: Install uv via official installer (Linux)
      # uv installer pinned to version (update periodically)
      # Latest version: https://github.com/astral-sh/uv/releases
      ansible.builtin.shell: curl -LsSf https://astral.sh/uv/0.9.26/install.sh | sh
      args:
        creates: ~/.local/bin/uv
      when: ansible_facts['os_family'] in ["Debian", "Archlinux"]
```
  </action>
  <verify>grep -E "(--version|astral.sh/uv/0\.)" tools/pulumi/install_pulumi.yml tools/python/install_python.yml</verify>
  <done>Pulumi uses --version 3.216.0, uv uses versioned URL /uv/0.9.26/</done>
</task>

<task type="auto">
  <name>Task 3: Add security comments to unpinnable scripts</name>
  <files>tools/rust/install_rust.yml, tools/starship/install_starship.yml</files>
  <action>
Read each file first, then add security disclaimer comments explaining why these cannot be pinned.

**tools/rust/install_rust.yml:**
Add comment above the curl-pipe task:
```yaml
    - name: Install Rust via rustup (Linux)
      # SECURITY: rustup installer cannot be pinned - no versioned installer exists
      # The rustup project maintains https://sh.rustup.rs as the canonical installer.
      # Mitigation: Trust HTTPS + official domain. Alternative: standalone installers
      # with GPG signatures at https://forge.rust-lang.org/infra/other-installation-methods.html
      ansible.builtin.shell: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
```

**tools/starship/install_starship.yml:**
Add comment above the curl-pipe task:
```yaml
    - name: Install Starship via official installer (Linux)
      # SECURITY: Starship installer cannot be pinned - no versioned installer exists
      # Alternative: Download binary directly with checksum from GitHub releases
      # https://github.com/starship/starship/releases (provides SHA256 checksums)
      ansible.builtin.shell: curl -sS https://starship.rs/install.sh | sh -s -- -y
```
  </action>
  <verify>grep -l "cannot be pinned" tools/rust/install_rust.yml tools/starship/install_starship.yml | wc -l</verify>
  <done>Both files have "cannot be pinned" security comments explaining the limitation</done>
</task>

</tasks>

<verification>
```bash
# All curl-pipe scripts either pinned or have security comments
grep -r "HEAD/install.sh" bootstrap.sh tools/ && echo "FAIL: HEAD still present" || echo "PASS: No HEAD references"

# Lint passes
ansible-lint tools/homebrew/install_homebrew.yml tools/pulumi/install_pulumi.yml tools/python/install_python.yml tools/rust/install_rust.yml tools/starship/install_starship.yml
```
</verification>

<success_criteria>
- bootstrap.sh and homebrew playbook use commit SHA instead of HEAD
- Pulumi uses --version flag with specific version
- uv uses versioned URL path
- Rust and Starship have "cannot be pinned" security comments
- ansible-lint passes on all modified files
</success_criteria>

<output>
After completion, create `.planning/phases/09-script-security/09-01-SUMMARY.md`
</output>
