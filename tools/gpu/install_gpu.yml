---
# GPU Driver Installation
#
# Detects GPU hardware and installs appropriate drivers with gaming support.
# Includes Vulkan, 32-bit libraries, and proper driver configuration.
#
# Supported GPUs:
#   - NVIDIA: Proprietary drivers with nouveau blacklist
#   - AMD: Mesa with Vulkan (RADV)
#   - Intel: Mesa with Vulkan (ANV)

- name: Install GPU Drivers
  hosts: all
  gather_facts: true

  tasks:
    # GPU Detection (Linux only)
    - name: Detect GPU hardware
      ansible.builtin.shell: lspci | grep -iE 'vga|3d|display'
      register: gpu_lspci
      changed_when: false
      failed_when: false
      check_mode: false
      when: ansible_facts['os_family'] != "Darwin"

    - name: Set GPU type facts
      ansible.builtin.set_fact:
        has_nvidia: "{{ 'NVIDIA' in gpu_lspci.stdout | default('') }}"
        has_amd: "{{ 'AMD' in gpu_lspci.stdout | default('') or 'ATI' in gpu_lspci.stdout | default('') }}"
        has_intel: "{{ 'Intel' in gpu_lspci.stdout | default('') }}"
      when: ansible_facts['os_family'] != "Darwin"

    - name: Display detected GPUs
      ansible.builtin.debug:
        msg: "Detected GPUs - NVIDIA: {{ has_nvidia }}, AMD: {{ has_amd }}, Intel: {{ has_intel }}"
      when: ansible_facts['os_family'] != "Darwin"

    # Arch Linux - Common Vulkan loader
    - name: Install Vulkan ICD loader (Arch)
      community.general.pacman:
        name:
          - vulkan-icd-loader
          - lib32-vulkan-icd-loader
        state: present
      become: true
      when: ansible_facts['os_family'] == "Archlinux"

    # Arch Linux - NVIDIA (using nvidia-dkms for kernel-agnostic support)
    - name: Install NVIDIA drivers (Arch)
      community.general.pacman:
        name:
          - nvidia-dkms
          - nvidia-utils
          - lib32-nvidia-utils
          - nvidia-settings
        state: present
      become: true
      when: ansible_facts['os_family'] == "Archlinux" and has_nvidia | default(false)

    - name: Blacklist nouveau driver (Arch)
      ansible.builtin.copy:
        dest: /etc/modprobe.d/blacklist-nouveau.conf
        content: |
          blacklist nouveau
          options nouveau modeset=0
        mode: '0644'
      become: true
      when: ansible_facts['os_family'] == "Archlinux" and has_nvidia | default(false)

    # Arch Linux - AMD
    - name: Install AMD drivers (Arch)
      community.general.pacman:
        name:
          - mesa
          - lib32-mesa
          - vulkan-radeon
          - lib32-vulkan-radeon
          - xf86-video-amdgpu
        state: present
      become: true
      when: ansible_facts['os_family'] == "Archlinux" and has_amd | default(false)

    # Arch Linux - Intel
    - name: Install Intel drivers (Arch)
      community.general.pacman:
        name:
          - mesa
          - lib32-mesa
          - vulkan-intel
          - lib32-vulkan-intel
        state: present
      become: true
      when: ansible_facts['os_family'] == "Archlinux" and has_intel | default(false)

    # Arch Linux - Add user to video group
    - name: Add user to video group (Arch)
      ansible.builtin.user:
        name: "{{ ansible_facts['user_id'] }}"
        groups: video
        append: true
      become: true
      when: ansible_facts['os_family'] == "Archlinux"

    # Debian - Enable non-free repos for NVIDIA
    - name: Add Debian non-free repository for NVIDIA (Debian)
      ansible.builtin.deb822_repository:
        name: debian-nonfree
        types: deb
        uris: https://deb.debian.org/debian
        suites: "{{ ansible_distribution_release }}"
        components:
          - contrib
          - non-free
          - non-free-firmware
        state: present
      become: true
      when: ansible_facts['os_family'] == "Debian" and has_nvidia | default(false)

    - name: Update apt cache after adding non-free repo (Debian)
      ansible.builtin.apt:
        update_cache: true
      become: true
      when: ansible_facts['os_family'] == "Debian" and has_nvidia | default(false)

    # Debian - NVIDIA
    - name: Install NVIDIA drivers (Debian)
      ansible.builtin.apt:
        name:
          - nvidia-driver
          - nvidia-settings
          - firmware-misc-nonfree
        state: present
      become: true
      when: ansible_facts['os_family'] == "Debian" and has_nvidia | default(false)

    # Debian - AMD
    - name: Install AMD drivers (Debian)
      ansible.builtin.apt:
        name:
          - firmware-amd-graphics
          - mesa-vulkan-drivers
          - libvulkan1
        state: present
      become: true
      when: ansible_facts['os_family'] == "Debian" and has_amd | default(false)

    # Debian - Intel
    - name: Install Intel drivers (Debian)
      ansible.builtin.apt:
        name:
          - intel-media-va-driver
          - mesa-vulkan-drivers
          - libvulkan1
        state: present
      become: true
      when: ansible_facts['os_family'] == "Debian" and has_intel | default(false)

    # Debian - Add user to video group
    - name: Add user to video group (Debian)
      ansible.builtin.user:
        name: "{{ ansible_facts['user_id'] }}"
        groups: video
        append: true
      become: true
      when: ansible_facts['os_family'] == "Debian"

    # macOS - Log GPU info (drivers are built-in via Metal)
    - name: Get GPU info (macOS)
      ansible.builtin.shell: system_profiler SPDisplaysDataType
      register: macos_gpu_info
      changed_when: false
      when: ansible_facts['os_family'] == "Darwin"

    - name: Display macOS GPU info
      ansible.builtin.debug:
        msg: "{{ macos_gpu_info.stdout_lines }}"
      when: ansible_facts['os_family'] == "Darwin"
