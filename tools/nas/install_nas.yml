- name: Install NAS automount
  hosts: with_nas
  gather_facts: true
  vars:
    nas_server: nas.home.lan
    nas_shares:
      - name: home
        mount_point: "{{ ansible_env.HOME }}/NAS/home"
  tasks:
    # macOS setup using autofs
    - name: Check if NAS mount exists (macOS)
      ansible.builtin.stat:
        path: "{{ ansible_env.HOME }}/NAS"
      register: nas_mount
      when: ansible_facts['os_family'] == "Darwin"

    - name: Create NAS base directory (macOS)
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/NAS"
        state: directory
        mode: "0755"
      when:
        - ansible_facts['os_family'] == "Darwin"
        - not nas_mount.stat.exists
    - name: Create autofs map file (macOS)
      ansible.builtin.copy:
        dest: /etc/auto_nas
        content: |
          {% for share in nas_shares %}
          {{ share.name }} -fstype=smbfs,soft ://{{ nas_server }}/{{ share.name }}
          {% endfor %}
        mode: "0644"
      become: true
      when: ansible_facts['os_family'] == "Darwin"
    - name: Add NAS to auto_master (macOS)
      ansible.builtin.lineinfile:
        path: /etc/auto_master
        line: "/System/Volumes/Data/Users/{{ ansible_user_id }}/NAS /etc/auto_nas"
        state: present
      become: true
      when: ansible_facts['os_family'] == "Darwin"
      notify: Restart autofs macOS
    # Debian/Ubuntu setup using autofs
    - name: Install autofs and cifs-utils (Debian)
      ansible.builtin.apt:
        name:
          - autofs
          - cifs-utils
        state: present
      become: true
      when: ansible_facts['os_family'] == "Debian"
    - name: Create NAS credentials file (Debian)
      ansible.builtin.copy:
        dest: "{{ ansible_env.HOME }}/.nas-credentials"
        content: |
          username=guest
          password=
        mode: "0600"
      when: ansible_facts['os_family'] == "Debian"
    - name: Create autofs map file (Debian)
      ansible.builtin.copy:
        dest: /etc/auto.nas
        content: |
          {% for share in nas_shares %}
          {{ share.name }} -fstype=cifs,credentials={{ ansible_env.HOME }}/.nas-credentials,uid={{ ansible_user_id }},gid={{ ansible_user_id }} ://{{ nas_server }}/{{ share.name }}
          {% endfor %}
        mode: "0644"
      become: true
      when: ansible_facts['os_family'] == "Debian"
    - name: Add NAS to auto.master (Debian)
      ansible.builtin.lineinfile:
        path: /etc/auto.master
        line: "{{ ansible_env.HOME }}/NAS /etc/auto.nas --timeout=60"
        insertbefore: "^\\+auto.master"
        state: present
      become: true
      when: ansible_facts['os_family'] == "Debian"
      notify: Restart autofs Debian
    # Arch Linux setup using autofs
    - name: Install cifs-utils (Arch)
      community.general.pacman:
        name:
          - cifs-utils
        state: present
        update_cache: true
      become: true
      when: ansible_facts['os_family'] == "Archlinux"

    - name: Check if autofs is installed (Arch)
      ansible.builtin.command: pacman -Q autofs
      register: autofs_check
      ignore_errors: true
      changed_when: false
      when: ansible_facts['os_family'] == "Archlinux"

    - name: Install autofs via yay (Arch)
      ansible.builtin.command: yay -S --noconfirm autofs
      when:
        - ansible_facts['os_family'] == "Archlinux"
        - autofs_check.rc != 0
    - name: Create NAS credentials file (Arch)
      ansible.builtin.copy:
        dest: "{{ ansible_env.HOME }}/.nas-credentials"
        content: |
          username=guest
          password=
        mode: "0600"
      when: ansible_facts['os_family'] == "Archlinux"
    - name: Create autofs map file (Arch)
      ansible.builtin.copy:
        dest: /etc/autofs/auto.nas
        content: |
          {% for share in nas_shares %}
          {{ share.name }} -fstype=cifs,credentials={{ ansible_env.HOME }}/.nas-credentials,uid={{ ansible_user_id }},gid={{ ansible_user_id }} ://{{ nas_server }}/{{ share.name }}
          {% endfor %}
        mode: "0644"
      become: true
      when: ansible_facts['os_family'] == "Archlinux"
    - name: Add NAS to auto.master (Arch)
      ansible.builtin.lineinfile:
        path: /etc/autofs/auto.master
        line: "{{ ansible_env.HOME }}/NAS /etc/autofs/auto.nas --timeout=60"
        state: present
      become: true
      when: ansible_facts['os_family'] == "Archlinux"
      notify: Restart autofs Arch
  handlers:
    - name: Restart autofs macOS
      ansible.builtin.command: automount -vc
      become: true
    - name: Restart autofs Debian
      ansible.builtin.service:
        name: autofs
        state: restarted
      become: true
    - name: Restart autofs Arch
      ansible.builtin.service:
        name: autofs
        state: restarted
      become: true
