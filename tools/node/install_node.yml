- name: Install Node.js via nvm
  hosts: all
  gather_facts: true
  vars:
    nvm_dir: ~/.nvm
  tasks:
    # macOS: Install nvm via Homebrew
    - name: Install nvm via Homebrew
      ansible.builtin.shell: /opt/homebrew/bin/brew install nvm
      args:
        creates: /opt/homebrew/opt/nvm
      when: ansible_facts['os_family'] == "Darwin"
    - name: Create nvm directory
      ansible.builtin.file:
        path: "{{ nvm_dir }}"
        state: directory
    - name: Create zsh config directory
      ansible.builtin.file:
        path: ~/.config/zsh
        state: directory
    - name: Install node zsh config (lazy-load nvm)
      ansible.builtin.copy:
        src: node.zsh
        dest: ~/.config/zsh/node.zsh
    - name: Source node config in zshrc
      ansible.builtin.lineinfile:
        path: ~/.zshrc
        line: source ~/.config/zsh/node.zsh
        create: true
    - name: Remove old NVM block from zshrc
      ansible.builtin.blockinfile:
        path: ~/.zshrc
        marker: "# {mark} NVM"
        state: absent
    - name: Install Node.js LTS (macOS)
      ansible.builtin.shell: |
        export NVM_DIR="$HOME/.nvm"
        . /opt/homebrew/opt/nvm/nvm.sh
        nvm install --lts
        nvm alias default lts/*
      args:
        creates: ~/.nvm/alias/default
      when: ansible_facts['os_family'] == "Darwin"
    # Debian/Arch: Install nvm from official script
    - name: Install nvm from official script (Linux)
      ansible.builtin.shell: curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
      args:
        creates: ~/.nvm/nvm.sh
      when: ansible_facts['os_family'] in ["Debian", "Archlinux"]
    - name: Install Node.js LTS (Linux)
      ansible.builtin.shell: |
        export NVM_DIR="$HOME/.nvm"
        . ~/.nvm/nvm.sh
        nvm install --lts
        nvm alias default lts/*
      args:
        creates: ~/.nvm/alias/default
      when: ansible_facts['os_family'] in ["Debian", "Archlinux"]
    - name: Install global npm packages (macOS)
      ansible.builtin.shell: |
        export NVM_DIR="$HOME/.nvm"
        . /opt/homebrew/opt/nvm/nvm.sh
        npm install -g typescript @fsouza/prettierd eslint_d
      args:
        creates: ~/.nvm/versions/node/*/bin/tsc
      when: ansible_facts['os_family'] == "Darwin"
    - name: Install global npm packages (Linux)
      ansible.builtin.shell: |
        export NVM_DIR="$HOME/.nvm"
        . ~/.nvm/nvm.sh
        npm install -g typescript @fsouza/prettierd eslint_d
      args:
        creates: ~/.nvm/versions/node/*/bin/tsc
      when: ansible_facts['os_family'] in ["Debian", "Archlinux"]
