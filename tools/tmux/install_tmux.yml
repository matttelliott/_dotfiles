---
- name: Install tmux
  hosts: all
  gather_facts: true

  tasks:
    - name: Install tmux via Homebrew
      shell: /opt/homebrew/bin/brew install tmux
      args:
        creates: /opt/homebrew/bin/tmux
      when: ansible_facts['os_family'] == "Darwin"

    - name: Install tmux via apt
      apt:
        name: tmux
        state: present
      become: yes
      when: ansible_facts['os_family'] == "Debian"

    - name: Install tmux config
      copy:
        dest: ~/.tmux.conf
        content: |
          # tmux Configuration
          # Optimized for development with vim-like navigation and modern terminal features

          # TokyoNight colors
          set -g status-style "bg=#1a1b26,fg=#c0caf5"
          set -g status-left "#[bg=#7aa2f7,fg=#1a1b26,bold] #S #[bg=#1a1b26] "
          set -g status-right "#[fg=#9ece6a]#(pmset -g batt | grep -Eo '[0-9]+%%' | head -1 || cat /sys/class/power_supply/BAT*/capacity 2>/dev/null | head -1)%% #[fg=#7aa2f7]%Y-%m-%d %H:%M #[bg=#7aa2f7,fg=#1a1b26,bold] #h "
          set -g status-left-length 50
          set -g status-right-length 50
          set -g status-justify left
          setw -g window-status-format "#[fg=#565f89] #I:#W "
          setw -g window-status-current-format "#[fg=#7aa2f7,bold] #I:#W "
          set -g pane-border-style "fg=#565f89"
          set -g pane-active-border-style "fg=#7aa2f7"
          set -g message-style "bg=#1a1b26,fg=#7aa2f7"

          # Key Bindings Configuration
          unbind C-b
          set -g prefix C-a
          bind C-a send-prefix

          # Terminal Configuration
          set-option -g default-terminal "tmux-256color"
          set -g default-terminal "${TERM}"
          set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
          set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

          # Window and Pane Indexing
          set -g base-index 1
          setw -g pane-base-index 1

          # Vi Mode Configuration
          setw -g mode-keys vi

          # Copy Mode Configuration
          bind Escape copy-mode
          bind -T copy-mode-vi v send-keys -X begin-selection
          bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'pbcopy'
          unbind p
          bind p paste-buffer

          # Performance and Responsiveness
          set -sg escape-time 1
          set -g history-limit 50000
          set -g display-time 4000
          set -g focus-events on
          setw -g aggressive-resize on

          # Window and Pane Management
          set-option -g allow-rename off

          # Pane Navigation (vim-style)
          bind h select-pane -L
          bind j select-pane -D
          bind k select-pane -U
          bind l select-pane -R

          # Pane Resizing
          bind -r c-h resize-pane -L 5
          bind -r c-j resize-pane -D 5
          bind -r c-k resize-pane -U 5
          bind -r c-l resize-pane -R 5

          # Window Navigation
          bind -r c-p previous-window
          bind -r c-n next-window

          # Smart Pane and Window Creation
          bind '"' split-window -c "#{pane_current_path}"
          bind % split-window -h -c "#{pane_current_path}"
          bind c new-window -c "#{pane_current_path}"

          # Mouse Support
          set -g mouse on
