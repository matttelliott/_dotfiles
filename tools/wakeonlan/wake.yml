# Wake Hosts via Wake-on-LAN
#
# Sends magic packets to wake sleeping/powered-off machines.
# Requires wol_mac_addresses.yml (generated by gather_mac_addresses.yml)
#
# Usage:
#   Wake all hosts:     ansible-playbook tools/wakeonlan/wake.yml
#   Wake specific host: ansible-playbook tools/wakeonlan/wake.yml -e "wake_hosts=desktop"
#   Wake multiple:      ansible-playbook tools/wakeonlan/wake.yml -e "wake_hosts=desktop,macmini"
- name: Wake hosts via Wake-on-LAN
  hosts: localhost
  connection: local
  gather_facts: true
  vars_files:
    - "{{ playbook_dir }}/../../wol_mac_addresses.yml"
  tasks:
    - name: Install wakeonlan (macOS)
      command: brew install wakeonlan
      args:
        creates: /opt/homebrew/bin/wakeonlan
      when: ansible_facts['os_family'] == "Darwin"
    - name: Install wakeonlan (Debian)
      apt:
        name: wakeonlan
        state: present
      become: true
      when: ansible_facts['os_family'] == "Debian"
    - name: Install wakeonlan (Arch)
      pacman:
        name: wakeonlan
        state: present
      become: true
      when: ansible_facts['os_family'] == "Archlinux"
    - name: Set hosts to wake
      set_fact:
        hosts_to_wake: "{{ (wake_hosts | default(wol_mac_addresses.keys() | join(','))).split(',') }}"
    - name: Send wake-on-LAN packet
      command: wakeonlan {{ wol_mac_addresses[item] }}
      loop: "{{ hosts_to_wake }}"
      when: wol_mac_addresses[item] is defined
      register: wol_result
    - name: Show wake results
      debug:
        msg: "Sent WOL packet to {{ item.item }} ({{ wol_mac_addresses[item.item] }})"
      loop: "{{ wol_result.results }}"
      when: item.rc is defined and item.rc == 0
